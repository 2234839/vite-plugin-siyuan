{"version":3,"file":"index.js","sources":["../../src/vite-plugin-siyuan/index.ts"],"sourcesContent":["// 引入这个变量后 vite 会自动注入 hot\r\nimport.meta.hot;\r\nimport siyuan from \"siyuan\";\r\n\r\n//@ts-ignore\r\nconst rawRequire = globalThis.require;\r\n//@ts-ignore\r\nglobalThis.require = (moduleName: string) => {\r\n  if (moduleName === \"siyuan\") {\r\n    return siyuan;\r\n  }\r\n  return rawRequire(moduleName);\r\n};\r\n\r\nexport default class VitePlugin extends siyuan.Plugin {\r\n  async onload() {\r\n    // @ts-ignore\r\n    globalThis.vitePlugin = this;\r\n    const url = await this.loadData(\"url\");\r\n    if (!url) return;\r\n    this.loadByUrl(url);\r\n  }\r\n  layoutRead = false;\r\n  onLayoutReady(): void {\r\n    this.layoutRead = true;\r\n  }\r\n  public async loadByUrl(url: string) {\r\n    this.saveData(\"url\", url);\r\n\r\n    let moduleSrc = `${url}?t=${Date.now()}`;\r\n    console.log(\"[url]\", url);\r\n    // 插件名，插件的loadData 之类的方法和插件名是相关的\r\n    let name = \"\";\r\n    if (url.endsWith(\"/index.ts\")) {\r\n      const pluginJSON: { name: string } = await fetch(\r\n        url.replace(/\\/index\\.ts$/, \"/plugin.json\"),\r\n      ).then((r) => r.json());\r\n      console.log(\"[pluginJSON]\", pluginJSON);\r\n      name = pluginJSON.name;\r\n    }\r\n    import(moduleSrc).then((module) => {\r\n      const pluginClass = module.default;\r\n      const plugin = new pluginClass({\r\n        app: this.app,\r\n        displayName: name || pluginClass.name,\r\n        name: name || pluginClass.name,\r\n        i18n: {},\r\n      }) as siyuan.Plugin;\r\n      this.app.plugins.push(plugin);\r\n      plugin.onload();\r\n      if (this.layoutRead) {\r\n        plugin.onLayoutReady();\r\n      }\r\n      console.log(\"[load plugin]\", { module, pluginClass, plugin });\r\n    });\r\n  }\r\n  public async setViteUrl(url: string) {\r\n    await this.saveData(\"url\", url);\r\n    this.loadByUrl(url);\r\n  }\r\n}\r\n"],"names":["module"],"mappings":";;;;;AAKA,MAAM,aAAa,WAAW;AAE9B,WAAW,UAAU,CAAC,eAAuB;AAC3C,MAAI,eAAe,UAAU;AACpB,WAAA;AAAA,EACT;AACA,SAAO,WAAW,UAAU;AAC9B;AAEqB,MAAA,mBAAmB,OAAO,OAAO;AAAA,EAAjC;AAAA;AAQnB,sCAAa;AAAA;AAAA,EAPb,MAAM,SAAS;AAEb,eAAW,aAAa;AACxB,UAAM,MAAM,MAAM,KAAK,SAAS,KAAK;AACrC,QAAI,CAAC,IAAK;AACV,SAAK,UAAU,GAAG;AAAA,EACpB;AAAA,EAEA,gBAAsB;AACpB,SAAK,aAAa;AAAA,EACpB;AAAA,EACA,MAAa,UAAU,KAAa;AAC7B,SAAA,SAAS,OAAO,GAAG;AAExB,QAAI,YAAY,GAAG,GAAG,MAAM,KAAK,IAAK,CAAA;AAC9B,YAAA,IAAI,SAAS,GAAG;AAExB,QAAI,OAAO;AACP,QAAA,IAAI,SAAS,WAAW,GAAG;AAC7B,YAAM,aAA+B,MAAM;AAAA,QACzC,IAAI,QAAQ,gBAAgB,cAAc;AAAA,QAC1C,KAAK,CAAC,MAAM,EAAE,KAAM,CAAA;AACd,cAAA,IAAI,gBAAgB,UAAU;AACtC,aAAO,WAAW;AAAA,IACpB;AACO,WAAA,WAAW,KAAK,CAACA,YAAW;AACjC,YAAM,cAAcA,QAAO;AACrB,YAAA,SAAS,IAAI,YAAY;AAAA,QAC7B,KAAK,KAAK;AAAA,QACV,aAAa,QAAQ,YAAY;AAAA,QACjC,MAAM,QAAQ,YAAY;AAAA,QAC1B,MAAM,CAAC;AAAA,MAAA,CACR;AACI,WAAA,IAAI,QAAQ,KAAK,MAAM;AAC5B,aAAO,OAAO;AACd,UAAI,KAAK,YAAY;AACnB,eAAO,cAAc;AAAA,MACvB;AACA,cAAQ,IAAI,iBAAiB,EAAE,QAAAA,SAAQ,aAAa,QAAQ;AAAA,IAAA,CAC7D;AAAA,EACH;AAAA,EACA,MAAa,WAAW,KAAa;AAC7B,UAAA,KAAK,SAAS,OAAO,GAAG;AAC9B,SAAK,UAAU,GAAG;AAAA,EACpB;AACF;;"}