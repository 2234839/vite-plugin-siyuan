{"version":3,"file":"index.js","sources":["../../src/vite-plugin-siyuan/index.ts"],"sourcesContent":["// 引入这个变量后 vite 会自动注入 hot\r\nimport.meta.hot;\r\nimport siyuan from \"siyuan\";\r\n\r\n//@ts-ignore\r\nconst rawRequire = globalThis.require;\r\n//@ts-ignore\r\nglobalThis.require = (moduleName: string) => {\r\n  if (moduleName === \"siyuan\") {\r\n    return siyuan;\r\n  }\r\n  return rawRequire(moduleName);\r\n};\r\n\r\nexport default class VitePlugin extends siyuan.Plugin {\r\n  async onload() {\r\n    // @ts-ignore\r\n    globalThis.vitePlugin = this;\r\n    const url = await this.loadData(\"url\");\r\n    if (!url) return;\r\n    this.loadByUrl(url, false);\r\n  }\r\n  layoutRead = false;\r\n  onLayoutReady(): void {\r\n    this.layoutRead = true;\r\n  }\r\n  public async loadByUrl(url: string, save = true) {\r\n    if (save) {\r\n      this.saveData(\"url\", url);\r\n    }\r\n\r\n    let moduleSrc = `${url}?t=${Date.now()}`;\r\n    console.log(\"[url]\", url);\r\n    // 插件名，插件的loadData 之类的方法和插件名是相关的\r\n    if (url.endsWith(\"/index.ts\")) {\r\n    }\r\n    Promise.all([\r\n      fetch(url.replace(/\\/index\\.ts$/, \"/plugin.json\")).then((r) => r.json()),\r\n      import(moduleSrc),\r\n    ]).then(([pluginJSON, module]) => {\r\n      console.log(\"[pluginJSON]\", pluginJSON);\r\n      const name = pluginJSON.name;\r\n\r\n      const pluginClass = module.default;\r\n      const pluginName = name || pluginClass.name;\r\n      const plugin = new pluginClass({\r\n        app: this.app,\r\n        displayName: pluginName,\r\n        name: pluginName,\r\n        i18n: {},\r\n      }) as siyuan.Plugin;\r\n\r\n      const oldPlugin = this.app.plugins.find((el) => el.name === pluginName);\r\n      oldPlugin?.onunload();\r\n\r\n      this.app.plugins.push(plugin);\r\n      plugin.onload();\r\n      if (this.layoutRead) {\r\n        plugin.onLayoutReady();\r\n      }\r\n      console.log(\"[load plugin]\", { module, pluginClass, plugin });\r\n    });\r\n  }\r\n  public async setViteUrl(url: string) {\r\n    await this.saveData(\"url\", url);\r\n    this.loadByUrl(url);\r\n  }\r\n}\r\n"],"names":["module"],"mappings":";;;;;AAKA,MAAM,aAAa,WAAW;AAE9B,WAAW,UAAU,CAAC,eAAuB;AAC3C,MAAI,eAAe,UAAU;AACpB,WAAA;AAAA,EACT;AACA,SAAO,WAAW,UAAU;AAC9B;AAEqB,MAAA,mBAAmB,OAAO,OAAO;AAAA,EAAjC;AAAA;AAQnB,sCAAa;AAAA;AAAA,EAPb,MAAM,SAAS;AAEb,eAAW,aAAa;AACxB,UAAM,MAAM,MAAM,KAAK,SAAS,KAAK;AACrC,QAAI,CAAC,IAAK;AACL,SAAA,UAAU,KAAK,KAAK;AAAA,EAC3B;AAAA,EAEA,gBAAsB;AACpB,SAAK,aAAa;AAAA,EACpB;AAAA,EACA,MAAa,UAAU,KAAa,OAAO,MAAM;AAC/C,QAAI,MAAM;AACH,WAAA,SAAS,OAAO,GAAG;AAAA,IAC1B;AAEA,QAAI,YAAY,GAAG,GAAG,MAAM,KAAK,IAAK,CAAA;AAC9B,YAAA,IAAI,SAAS,GAAG;AAEpB,QAAA,IAAI,SAAS,WAAW,EAAG;AAE/B,YAAQ,IAAI;AAAA,MACV,MAAM,IAAI,QAAQ,gBAAgB,cAAc,CAAC,EAAE,KAAK,CAAC,MAAM,EAAE,KAAA,CAAM;AAAA,MACvE,OAAO;AAAA,IACR,CAAA,EAAE,KAAK,CAAC,CAAC,YAAYA,OAAM,MAAM;AACxB,cAAA,IAAI,gBAAgB,UAAU;AACtC,YAAM,OAAO,WAAW;AAExB,YAAM,cAAcA,QAAO;AACrB,YAAA,aAAa,QAAQ,YAAY;AACjC,YAAA,SAAS,IAAI,YAAY;AAAA,QAC7B,KAAK,KAAK;AAAA,QACV,aAAa;AAAA,QACb,MAAM;AAAA,QACN,MAAM,CAAC;AAAA,MAAA,CACR;AAEK,YAAA,YAAY,KAAK,IAAI,QAAQ,KAAK,CAAC,OAAO,GAAG,SAAS,UAAU;AACtE,6CAAW;AAEN,WAAA,IAAI,QAAQ,KAAK,MAAM;AAC5B,aAAO,OAAO;AACd,UAAI,KAAK,YAAY;AACnB,eAAO,cAAc;AAAA,MACvB;AACA,cAAQ,IAAI,iBAAiB,EAAE,QAAAA,SAAQ,aAAa,QAAQ;AAAA,IAAA,CAC7D;AAAA,EACH;AAAA,EACA,MAAa,WAAW,KAAa;AAC7B,UAAA,KAAK,SAAS,OAAO,GAAG;AAC9B,SAAK,UAAU,GAAG;AAAA,EACpB;AACF;;"}