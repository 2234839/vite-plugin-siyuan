{"version":3,"file":"index.js","sources":["../../src/vite-plugin-siyuan/index.ts"],"sourcesContent":["// 引入这个变量后 vite 会自动注入 hot\r\nimport.meta.hot;\r\nimport siyuan from \"siyuan\";\r\n\r\n//@ts-ignore\r\nconst rawRequire = globalThis.require;\r\n//@ts-ignore\r\nglobalThis.require = (moduleName: string) => {\r\n  if (moduleName === \"siyuan\") {\r\n    return siyuan;\r\n  }\r\n  return rawRequire(moduleName);\r\n};\r\n\r\nexport default class VitePlugin extends siyuan.Plugin {\r\n  async onload() {\r\n    // @ts-ignore\r\n    globalThis.vitePlugin = this;\r\n    const url = await this.loadData(\"url\");\r\n    if (!url) return;\r\n    this.loadByUrl(url);\r\n  }\r\n  layoutRead = false;\r\n  onLayoutReady(): void {\r\n    this.layoutRead = true;\r\n  }\r\n  public loadByUrl(url: string) {\r\n    this.saveData(\"url\", url);\r\n\r\n    let src = `${url}?t=${Date.now()}`;\r\n    import(src).then((module) => {\r\n      const pluginClass = module.default;\r\n      const plugin = new pluginClass({\r\n        app: this.app,\r\n        displayName: pluginClass.name,\r\n        name: pluginClass.name,\r\n        i18n: {},\r\n      }) as siyuan.Plugin;\r\n      this.app.plugins.push(plugin);\r\n      plugin.onload();\r\n      if (this.layoutRead) {\r\n        plugin.onLayoutReady();\r\n      }\r\n      console.log(\"[load plugin]\", { module, pluginClass, plugin });\r\n    });\r\n  }\r\n  public async setViteUrl(url: string) {\r\n    await this.saveData(\"url\", url);\r\n    this.loadByUrl(url);\r\n  }\r\n}\r\n"],"names":["module"],"mappings":";;;;;AAKA,MAAM,aAAa,WAAW;AAE9B,WAAW,UAAU,CAAC,eAAuB;AAC3C,MAAI,eAAe,UAAU;AACpB,WAAA;AAAA,EACT;AACA,SAAO,WAAW,UAAU;AAC9B;AAEqB,MAAA,mBAAmB,OAAO,OAAO;AAAA,EAAjC;AAAA;AAQnB,sCAAa;AAAA;AAAA,EAPb,MAAM,SAAS;AAEb,eAAW,aAAa;AACxB,UAAM,MAAM,MAAM,KAAK,SAAS,KAAK;AACrC,QAAI,CAAC,IAAK;AACV,SAAK,UAAU,GAAG;AAAA,EACpB;AAAA,EAEA,gBAAsB;AACpB,SAAK,aAAa;AAAA,EACpB;AAAA,EACO,UAAU,KAAa;AACvB,SAAA,SAAS,OAAO,GAAG;AAExB,QAAI,MAAM,GAAG,GAAG,MAAM,KAAK,IAAK,CAAA;AACzB,WAAA,KAAK,KAAK,CAACA,YAAW;AAC3B,YAAM,cAAcA,QAAO;AACrB,YAAA,SAAS,IAAI,YAAY;AAAA,QAC7B,KAAK,KAAK;AAAA,QACV,aAAa,YAAY;AAAA,QACzB,MAAM,YAAY;AAAA,QAClB,MAAM,CAAC;AAAA,MAAA,CACR;AACI,WAAA,IAAI,QAAQ,KAAK,MAAM;AAC5B,aAAO,OAAO;AACd,UAAI,KAAK,YAAY;AACnB,eAAO,cAAc;AAAA,MACvB;AACA,cAAQ,IAAI,iBAAiB,EAAE,QAAAA,SAAQ,aAAa,QAAQ;AAAA,IAAA,CAC7D;AAAA,EACH;AAAA,EACA,MAAa,WAAW,KAAa;AAC7B,UAAA,KAAK,SAAS,OAAO,GAAG;AAC9B,SAAK,UAAU,GAAG;AAAA,EACpB;AACF;;"}