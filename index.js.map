{"version":3,"file":"index.js","sources":["../../src/libs/xhr.ts","../../src/vite-plugin-siyuan/index.ts"],"sourcesContent":["export function synchronousFetch(url: string, data: any):Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    // 创建一个新的 XMLHttpRequest 对象\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.open(\"POST\", url, false); // 第三个参数设置为 false 以启用同步请求\r\n\r\n    xhr.onload = function () {\r\n      if (xhr.status === 200) {\r\n        resolve(xhr.responseText);\r\n      } else {\r\n        reject(new Error(xhr.statusText));\r\n      }\r\n    };\r\n    xhr.onerror = function () {\r\n      reject(new Error(\"Request error\"));\r\n    };\r\n    xhr.send(JSON.stringify(data));\r\n  });\r\n}\r\n","// 引入这个变量后 vite 会自动注入 hot\r\nimport.meta.hot;\r\nimport siyuan from \"siyuan\";\r\nimport { synchronousFetch } from \"~/libs/xhr\";\r\nimport pluginJSON from \"./plugin.json\";\r\n//@ts-ignore\r\nconst rawRequire = globalThis.require;\r\n//@ts-ignore\r\nglobalThis.require = (moduleName: string) => {\r\n  if (moduleName === \"siyuan\") {\r\n    return siyuan;\r\n  }\r\n  return rawRequire(moduleName);\r\n};\r\n\r\nexport default class VitePlugin extends siyuan.Plugin {\r\n  async onload() {\r\n    // @ts-ignore\r\n    globalThis.vitePlugin = this;\r\n    // 因为思源的 onload 中的一些方法调用需要在同步之前调用，所以这里阻塞加载\r\n    const url = await synchronousFetch(\"/api/file/getFile\", {\r\n      path: `/data/storage/petal/${pluginJSON.name}/url`,\r\n    });\r\n    if (!url) return;\r\n    this.loadByUrl(url, false);\r\n  }\r\n  layoutRead = false;\r\n  onLayoutReady(): void {\r\n    this.layoutRead = true;\r\n  }\r\n  public async loadByUrl(url: string, save = true) {\r\n    if (save) {\r\n      this.saveData(\"url\", url);\r\n    }\r\n\r\n    let moduleSrc = `${url}?t=${Date.now()}`;\r\n    console.log(\"[url]\", url);\r\n    // 插件名，插件的loadData 之类的方法和插件名是相关的\r\n    if (url.endsWith(\"/index.ts\")) {\r\n    }\r\n    Promise.all([\r\n      JSON.parse(await synchronousFetch(url.replace(/\\/index\\.ts$/, \"/plugin.json\"), {})),\r\n      import(moduleSrc),\r\n    ]).then(([pluginJSON, module]) => {\r\n      console.log(\"[pluginJSON]\", pluginJSON);\r\n      const name = pluginJSON.name;\r\n\r\n      const pluginClass = module.default;\r\n      const pluginName = name || pluginClass.name;\r\n      const plugin = new pluginClass({\r\n        app: this.app,\r\n        displayName: pluginName,\r\n        name: pluginName,\r\n        i18n: {},\r\n      }) as siyuan.Plugin;\r\n\r\n      const oldPlugin = this.app.plugins.find((el) => el.name === pluginName);\r\n      oldPlugin?.onunload();\r\n\r\n      this.app.plugins.push(plugin);\r\n      plugin.onload();\r\n      if (this.layoutRead) {\r\n        plugin.onLayoutReady();\r\n      }\r\n      console.log(\"[load plugin]\", { module, pluginClass, plugin });\r\n    });\r\n  }\r\n  public async setViteUrl(url: string) {\r\n    await this.saveData(\"url\", url);\r\n    this.loadByUrl(url);\r\n  }\r\n}\r\n"],"names":["synchronousFetch","url","data","resolve","reject","xhr","rawRequire","moduleName","siyuan","VitePlugin","__publicField","pluginJSON","save","moduleSrc","module","name","pluginClass","pluginName","plugin","oldPlugin","el"],"mappings":"2MAAgB,SAAAA,EAAiBC,EAAaC,EAA2B,CACvE,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CAElC,IAAAC,EAAM,IAAI,eACVA,EAAA,KAAK,OAAQJ,EAAK,EAAK,EAE3BI,EAAI,OAAS,UAAY,CACnBA,EAAI,SAAW,IACjBF,EAAQE,EAAI,YAAY,EAExBD,EAAO,IAAI,MAAMC,EAAI,UAAU,CAAC,CAClC,EAEFA,EAAI,QAAU,UAAY,CACjBD,EAAA,IAAI,MAAM,eAAe,CAAC,CAAA,EAEnCC,EAAI,KAAK,KAAK,UAAUH,CAAI,CAAC,CAAA,CAC9B,CACH,4ZCZMI,EAAa,WAAW,QAE9B,WAAW,QAAWC,GAChBA,IAAe,SACVC,EAEFF,EAAWC,CAAU,EAGT,MAAAE,UAAmBD,EAAO,MAAO,CAAjC,kCAWnBE,EAAA,kBAAa,IAVb,MAAM,QAAS,CAEb,WAAW,WAAa,KAElB,MAAAT,EAAM,MAAMD,EAAiB,oBAAqB,CACtD,KAAM,uBAAuBW,EAAW,IAAI,MAAA,CAC7C,EACIV,GACA,KAAA,UAAUA,EAAK,EAAK,CAC3B,CAEA,eAAsB,CACpB,KAAK,WAAa,EACpB,CACA,MAAa,UAAUA,EAAaW,EAAO,GAAM,CAC3CA,GACG,KAAA,SAAS,MAAOX,CAAG,EAG1B,IAAIY,EAAY,GAAGZ,CAAG,MAAM,KAAK,IAAK,CAAA,GAC9B,QAAA,IAAI,QAASA,CAAG,EAEpBA,EAAI,SAAS,WAAW,EAE5B,QAAQ,IAAI,CACV,KAAK,MAAM,MAAMD,EAAiBC,EAAI,QAAQ,eAAgB,cAAc,EAAG,CAAA,CAAE,CAAC,EAClF,OAAOY,EACR,CAAA,EAAE,KAAK,CAAC,CAACF,EAAYG,CAAM,IAAM,CACxB,QAAA,IAAI,eAAgBH,CAAU,EACtC,MAAMI,EAAOJ,EAAW,KAElBK,EAAcF,EAAO,QACrBG,EAAaF,GAAQC,EAAY,KACjCE,EAAS,IAAIF,EAAY,CAC7B,IAAK,KAAK,IACV,YAAaC,EACb,KAAMA,EACN,KAAM,CAAC,CAAA,CACR,EAEKE,EAAY,KAAK,IAAI,QAAQ,KAAMC,GAAOA,EAAG,OAASH,CAAU,EACtEE,GAAA,MAAAA,EAAW,WAEN,KAAA,IAAI,QAAQ,KAAKD,CAAM,EAC5BA,EAAO,OAAO,EACV,KAAK,YACPA,EAAO,cAAc,EAEvB,QAAQ,IAAI,gBAAiB,CAAE,OAAAJ,EAAQ,YAAAE,EAAa,OAAAE,EAAQ,CAAA,CAC7D,CACH,CACA,MAAa,WAAWjB,EAAa,CAC7B,MAAA,KAAK,SAAS,MAAOA,CAAG,EAC9B,KAAK,UAAUA,CAAG,CACpB,CACF"}