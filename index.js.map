{"version":3,"file":"index.js","sources":["../../src/libs/xhr.ts","../../src/vite-plugin-siyuan/index.ts"],"sourcesContent":["export function synchronousFetch(url: string, data: any):Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    // 创建一个新的 XMLHttpRequest 对象\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.open(\"POST\", url, false); // 第三个参数设置为 false 以启用同步请求\r\n\r\n    xhr.onload = function () {\r\nconsole.log('[xhr]',xhr)\r\n      if (xhr.status === 200) {\r\n        resolve(xhr.responseText);\r\n      } else {\r\n        reject(new Error(xhr.statusText));\r\n      }\r\n    };\r\n    xhr.onerror = function () {\r\n      reject(new Error(\"Request error\"));\r\n    };\r\n    xhr.send(JSON.stringify(data));\r\n  });\r\n}\r\n","// 引入这个变量后 vite 会自动注入 hot\r\nimport.meta.hot;\r\nimport siyuan from \"siyuan\";\r\nimport { synchronousFetch } from \"~/libs/xhr\";\r\nimport pluginJSON from \"./plugin.json\";\r\n//@ts-ignore\r\nconst rawRequire = globalThis.require;\r\n//@ts-ignore\r\nglobalThis.require = (moduleName: string) => {\r\n  if (moduleName === \"siyuan\") {\r\n    return siyuan;\r\n  }\r\n  return rawRequire(moduleName);\r\n};\r\n\r\nexport default class VitePlugin extends siyuan.Plugin {\r\n  async onload() {\r\n    // @ts-ignore\r\n    globalThis.vitePlugin = this;\r\n    // 因为思源的 onload 中的一些方法调用需要在同步之前调用，所以这里阻塞加载\r\n    const url = await synchronousFetch(\"/api/file/getFile\", {\r\n      path: `/data/storage/petal/${pluginJSON.name}/url`,\r\n    });\r\n    if (!url) return;\r\n    this.loadByUrl(url, false);\r\n  }\r\n  layoutRead = false;\r\n  onLayoutReady(): void {\r\n    this.layoutRead = true;\r\n  }\r\n  public async loadByUrl(url: string, save = true) {\r\n    if (save) {\r\n      this.saveData(\"url\", url);\r\n    }\r\n\r\n    let moduleSrc = `${url}?t=${Date.now()}`;\r\n    console.log(\"[url]\", url);\r\n    // 插件名，插件的loadData 之类的方法和插件名是相关的\r\n    if (url.endsWith(\"/index.ts\")) {\r\n    }\r\n    Promise.all([\r\n      JSON.parse(await synchronousFetch(url.replace(/\\/index\\.ts$/, \"/plugin.json\"), {})),\r\n      import(moduleSrc),\r\n    ]).then(([pluginJSON, module]) => {\r\n      console.log(\"[pluginJSON]\", pluginJSON);\r\n      const name = pluginJSON.name;\r\n\r\n      const pluginClass = module.default;\r\n      const pluginName = name || pluginClass.name;\r\n      const plugin = new pluginClass({\r\n        app: this.app,\r\n        displayName: pluginName,\r\n        name: pluginName,\r\n        i18n: {},\r\n      }) as siyuan.Plugin;\r\n\r\n      const oldPlugin = this.app.plugins.find((el) => el.name === pluginName);\r\n      oldPlugin?.onunload();\r\n\r\n      this.app.plugins.push(plugin);\r\n      plugin.onload();\r\n      if (this.layoutRead) {\r\n        plugin.onLayoutReady();\r\n      }\r\n      console.log(\"[load plugin]\", { module, pluginClass, plugin });\r\n    });\r\n  }\r\n  public async setViteUrl(url: string) {\r\n    await this.saveData(\"url\", url);\r\n    this.loadByUrl(url);\r\n  }\r\n}\r\n"],"names":["url","pluginJSON","module","name"],"mappings":";;;;;AAAgB,SAAA,iBAAiBA,MAAa,MAA2B;AACvE,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAElC,QAAA,MAAM,IAAI;AACV,QAAA,KAAK,QAAQA,MAAK,KAAK;AAE3B,QAAI,SAAS,WAAY;AACrB,cAAA,IAAI,SAAQ,GAAG;AACb,UAAA,IAAI,WAAW,KAAK;AACtB,gBAAQ,IAAI,YAAY;AAAA,MAAA,OACnB;AACL,eAAO,IAAI,MAAM,IAAI,UAAU,CAAC;AAAA,MAClC;AAAA,IAAA;AAEF,QAAI,UAAU,WAAY;AACjB,aAAA,IAAI,MAAM,eAAe,CAAC;AAAA,IAAA;AAEnC,QAAI,KAAK,KAAK,UAAU,IAAI,CAAC;AAAA,EAAA,CAC9B;AACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACbA,MAAM,aAAa,WAAW;AAE9B,WAAW,UAAU,CAAC,eAAuB;AAC3C,MAAI,eAAe,UAAU;AACpB,WAAA;AAAA,EACT;AACA,SAAO,WAAW,UAAU;AAC9B;AAEqB,MAAA,mBAAmB,OAAO,OAAO;AAAA,EAAjC;AAAA;AAWnB,sCAAa;AAAA;AAAA,EAVb,MAAM,SAAS;AAEb,eAAW,aAAa;AAElB,UAAAA,OAAM,MAAM,iBAAiB,qBAAqB;AAAA,MACtD,MAAM,uBAAuB,WAAW,IAAI;AAAA,IAAA,CAC7C;AACD,QAAI,CAACA,KAAK;AACL,SAAA,UAAUA,MAAK,KAAK;AAAA,EAC3B;AAAA,EAEA,gBAAsB;AACpB,SAAK,aAAa;AAAA,EACpB;AAAA,EACA,MAAa,UAAUA,MAAa,OAAO,MAAM;AAC/C,QAAI,MAAM;AACH,WAAA,SAAS,OAAOA,IAAG;AAAA,IAC1B;AAEA,QAAI,YAAY,GAAGA,IAAG,MAAM,KAAK,IAAK,CAAA;AAC9B,YAAA,IAAI,SAASA,IAAG;AAEpB,QAAAA,KAAI,SAAS,WAAW,EAAG;AAE/B,YAAQ,IAAI;AAAA,MACV,KAAK,MAAM,MAAM,iBAAiBA,KAAI,QAAQ,gBAAgB,cAAc,GAAG,CAAA,CAAE,CAAC;AAAA,MAClF,OAAO;AAAA,IACR,CAAA,EAAE,KAAK,CAAC,CAACC,aAAYC,OAAM,MAAM;AACxB,cAAA,IAAI,gBAAgBD,WAAU;AACtC,YAAME,QAAOF,YAAW;AAExB,YAAM,cAAcC,QAAO;AACrB,YAAA,aAAaC,SAAQ,YAAY;AACjC,YAAA,SAAS,IAAI,YAAY;AAAA,QAC7B,KAAK,KAAK;AAAA,QACV,aAAa;AAAA,QACb,MAAM;AAAA,QACN,MAAM,CAAC;AAAA,MAAA,CACR;AAEK,YAAA,YAAY,KAAK,IAAI,QAAQ,KAAK,CAAC,OAAO,GAAG,SAAS,UAAU;AACtE,6CAAW;AAEN,WAAA,IAAI,QAAQ,KAAK,MAAM;AAC5B,aAAO,OAAO;AACd,UAAI,KAAK,YAAY;AACnB,eAAO,cAAc;AAAA,MACvB;AACA,cAAQ,IAAI,iBAAiB,EAAE,QAAAD,SAAQ,aAAa,QAAQ;AAAA,IAAA,CAC7D;AAAA,EACH;AAAA,EACA,MAAa,WAAWF,MAAa;AAC7B,UAAA,KAAK,SAAS,OAAOA,IAAG;AAC9B,SAAK,UAAUA,IAAG;AAAA,EACpB;AACF;;"}