"use strict";var m=Object.defineProperty;var f=(e,s,n)=>s in e?m(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n;var c=(e,s,n)=>f(e,typeof s!="symbol"?s+"":s,n);const h=require("siyuan");function d(e,s){return new Promise((n,a)=>{var t=new XMLHttpRequest;t.open("POST",e,!1),t.onload=function(){t.status===200?n(t.responseText):a(new Error(t.statusText))},t.onerror=function(){a(new Error("Request error"))},t.send(JSON.stringify(s))})}const v="vite-plugin-siyuan",w="崮生",R="https://github.com/2234839/vite-plugin-siyuan",N="0.0.25",S="2.10.3",x=["all"],U=["all"],b={en_US:"vite-plugin-siyuan",zh_CN:"vite-plugin-siyuan"},q={en_US:"",zh_CN:""},E={en_US:"README.md",zh_CN:"README.md"},T={custom:["https://afdian.com/@llej0"]},_={name:v,author:w,url:R,version:N,minAppVersion:S,backends:x,frontends:U,displayName:b,description:q,readme:E,funding:T},D=globalThis.require;globalThis.require=e=>e==="siyuan"?h:D(e);class P extends h.Plugin{constructor(){super(...arguments);c(this,"layoutRead",!1)}async onload(){globalThis.vitePlugin=this;const n=await d("/api/file/getFile",{path:`/data/storage/petal/${_.name}/url`});n&&this.loadByUrl(n,!1)}onLayoutReady(){this.layoutRead=!0}async loadByUrl(n,a=!0){a&&this.saveData("url",n);let t=`${n}?t=${Date.now()}`;console.log("[url]",n),n.endsWith("/index.ts"),Promise.all([JSON.parse(await d(n.replace(/\/index\.ts$/,"/plugin.json"),{})),import(t)]).then(([u,p])=>{console.log("[pluginJSON]",u);const g=u.name,o=p.default,l=g||o.name,i=new o({app:this.app,displayName:l,name:l,i18n:{}}),r=this.app.plugins.find(y=>y.name===l);r==null||r.onunload(),this.app.plugins.push(i),i.onload(),this.layoutRead&&i.onLayoutReady(),console.log("[load plugin]",{module:p,pluginClass:o,plugin:i})})}async setViteUrl(n){await this.saveData("url",n),this.loadByUrl(n)}}module.exports=P;
