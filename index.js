(function(t,i){typeof exports=="object"&&typeof module<"u"?module.exports=i(require("siyuan")):typeof define=="function"&&define.amd?define(["siyuan"],i):(t=typeof globalThis<"u"?globalThis:t||self,t["vite-plugin-siyuan"]=i(t.siyuan))})(this,(function(t){"use strict";function i(s,e){return new Promise((l,a)=>{var n=new XMLHttpRequest;n.open("POST",s,!1),n.onload=function(){n.status===200?l(n.responseText):a(new Error(n.statusText))},n.onerror=function(){a(new Error("Request error"))},n.send(JSON.stringify(e))})}const d={name:"vite-plugin-siyuan"},f=globalThis.require;globalThis.require=s=>s==="siyuan"?t:f(s);class c extends t.Plugin{async onload(){globalThis.vitePlugin=this;const e=await i("/api/file/getFile",{path:`/data/storage/petal/${d.name}/url`});e&&this.loadByUrl(e,!1)}layoutRead=!1;onLayoutReady(){this.layoutRead=!0}async loadByUrl(e,l=!0){l&&this.saveData("url",e);let a=`${e}?t=${Date.now()}`;console.log("[url]",e),e.endsWith("/index.ts"),Promise.all([JSON.parse(await i(e.replace(/\/index\.ts$/,"/plugin.json"),{})),import(a)]).then(([n,p])=>{console.log("[pluginJSON]",n);const g=n.name,u=p.default,r=g||u.name,o=new u({app:this.app,displayName:r,name:r,i18n:{}});this.app.plugins.find(h=>h.name===r)?.onunload(),this.app.plugins.push(o),o.onload(),this.layoutRead&&o.onLayoutReady(),console.log("[load plugin]",{module:p,pluginClass:u,plugin:o})})}async setViteUrl(e){await this.saveData("url",e),this.loadByUrl(e)}}return c}));
