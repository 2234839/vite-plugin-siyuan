"use strict";var f=Object.defineProperty;var m=(n,a,e)=>a in n?f(n,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[a]=e;var c=(n,a,e)=>m(n,typeof a!="symbol"?a+"":a,e);const g=require("siyuan");function d(n,a){return new Promise((e,s)=>{var t=new XMLHttpRequest;t.open("POST",n,!1),t.onload=function(){t.status===200?e(t.responseText):s(new Error(t.statusText))},t.onerror=function(){s(new Error("Request error"))},t.send(JSON.stringify(a))})}const w="vite-plugin-siyuan",R={name:w},x=globalThis.require;globalThis.require=n=>n==="siyuan"?g:x(n);class q extends g.Plugin{constructor(){super(...arguments);c(this,"layoutRead",!1)}async onload(){globalThis.vitePlugin=this;const e=await d("/api/file/getFile",{path:`/data/storage/petal/${R.name}/url`});e&&this.loadByUrl(e,!1)}onLayoutReady(){this.layoutRead=!0}async loadByUrl(e,s=!0){s&&this.saveData("url",e);let t=`${e}?t=${Date.now()}`;console.log("[url]",e),e.endsWith("/index.ts"),Promise.all([JSON.parse(await d(e.replace(/\/index\.ts$/,"/plugin.json"),{})),import(t)]).then(([u,p])=>{console.log("[pluginJSON]",u);const h=u.name,o=p.default,l=h||o.name,i=new o({app:this.app,displayName:l,name:l,i18n:{}}),r=this.app.plugins.find(y=>y.name===l);r==null||r.onunload(),this.app.plugins.push(i),i.onload(),this.layoutRead&&i.onLayoutReady(),console.log("[load plugin]",{module:p,pluginClass:o,plugin:i})})}async setViteUrl(e){await this.saveData("url",e),this.loadByUrl(e)}}module.exports=q;
