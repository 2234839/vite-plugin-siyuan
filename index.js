"use strict";var f=Object.defineProperty;var m=(n,t,e)=>t in n?f(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var c=(n,t,e)=>m(n,typeof t!="symbol"?t+"":t,e);const g=require("siyuan");function d(n,t){return new Promise((e,s)=>{var a=new XMLHttpRequest;a.open("POST",n,!1),a.onload=function(){a.status===200?e(a.responseText):s(new Error(a.statusText))},a.onerror=function(){s(new Error("Request error"))},a.send(JSON.stringify(t))})}const w="vite-plugin-siyuan",R={name:w},x=globalThis.require;globalThis.require=n=>n==="siyuan"?g:x(n);class q extends g.Plugin{constructor(){super(...arguments);c(this,"layoutRead",!1)}async onload(){globalThis.vitePlugin=this;const e=await d("/api/file/getFile",{path:`/data/storage/petal/${R.name}/url`});e&&this.loadByUrl(e,!1)}onLayoutReady(){this.layoutRead=!0}async loadByUrl(e,s=!0){s&&this.saveData("url",e);let a=`${e}?t=${Date.now()}`;console.log("[url]",e),e.endsWith("/index.ts"),Promise.all([JSON.parse(await d(e.replace(/\/index\.ts$/,"/plugin.json"),{})),import(a)]).then(([u,p])=>{console.log("[pluginJSON]",u);const h=u.name,o=p.default,l=h||o.name,i=new o({app:this.app,displayName:l,name:l,i18n:{}}),r=this.app.plugins.find(y=>y.name===l);r==null||r.onunload(),this.app.plugins.push(i),i.onload(),this.layoutRead&&i.onLayoutReady(),console.log("[load plugin]",{module:p,pluginClass:o,plugin:i})})}async setViteUrl(e){await this.saveData("url",e),this.loadByUrl(e)}}module.exports=q;
