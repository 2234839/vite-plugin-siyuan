"use strict";const p=require("siyuan");function u(t,e){return new Promise((i,a)=>{var n=new XMLHttpRequest;n.open("POST",t,!1),n.onload=function(){n.status===200?i(n.responseText):a(new Error(n.statusText))},n.onerror=function(){a(new Error("Request error"))},n.send(JSON.stringify(e))})}const g="vite-plugin-siyuan",h={name:g},y=globalThis.require;globalThis.require=t=>t==="siyuan"?p:y(t);class f extends p.Plugin{async onload(){globalThis.vitePlugin=this;const e=await u("/api/file/getFile",{path:`/data/storage/petal/${h.name}/url`});e&&this.loadByUrl(e,!1)}layoutRead=!1;onLayoutReady(){this.layoutRead=!0}async loadByUrl(e,i=!0){i&&this.saveData("url",e);let a=`${e}?t=${Date.now()}`;console.log("[url]",e),e.endsWith("/index.ts"),Promise.all([JSON.parse(await u(e.replace(/\/index\.ts$/,"/plugin.json"),{})),import(a)]).then(([n,r])=>{console.log("[pluginJSON]",n);const c=n.name,o=r.default,l=c||o.name,s=new o({app:this.app,displayName:l,name:l,i18n:{}});this.app.plugins.find(d=>d.name===l)?.onunload(),this.app.plugins.push(s),s.onload(),this.layoutRead&&s.onLayoutReady(),console.log("[load plugin]",{module:r,pluginClass:o,plugin:s})})}async setViteUrl(e){await this.saveData("url",e),this.loadByUrl(e)}}module.exports=f;
